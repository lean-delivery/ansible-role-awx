---
- name: Creates yum.repos.d directory
  file:
    path: /etc/yum.repos.d
    state: directory


- name: Install AWX repo
  get_url:
    url: https://copr.fedorainfracloud.org/coprs/mrmeee/ansible-awx/repo/epel-7/mrmeee-ansible-awx-epel-7.repo
    dest: /etc/yum.repos.d/mrmeee-ansible-awx-epel-7.repo

- name: Install EPEL Release
  package:
    name:
    - epel-release
    state: present
  register: installed-epel-release
  until: installed-epel-release is succeeded

- name: Install SCL
  package:
    name:
    - centos-release-scl
    - scl-utils-build
    state: present
  register: installed-scl
  until: installed-scl is succeeded

- name: Install RabbitMQ
  package:
    name: rabbitmq-server
    state: present
  register: installed-rabbit-mq
  until: installed-rabbit-mq is succeeded

- name: Install Postgres and Memcached
  package:
    name:
      - rh-postgresql10
      - memcached
    state: present
  register: installed-postgres
  until: installed-postgres is succeeded

- name: Install Python dependancies
  package:
    name:
      - rh-python36
    state: present
  register: installed-python-dependancies
  until: installed-python-dependancies is succeeded

- name: Install other Python dependancies
  yum:
    name:
      - 'rh-python36*'
    disablerepo:
    - '*'
    enablerepo:
    - mrmeee-ansible-awx
    - base
    exclude:
    - '*-debuginfo'
    state: present
  register: installed-python36
  until: installed-python36 is succeeded

- name: Install AWX
  yum:
    name:
    - ansible-awx
    state: present
  register: installed-awx
  until: installed-awx is succeeded
